/**
 * async-http.js - Simplify async http request using only dom attributes
 * @version v0.0.14
 * @link https://github.com/raphaelcarlosr/async-http.js
 * @license ISC
 * @author Raphael Carlos Rego <raphaelcarlosr@gmail.com>
 */
!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):"object"==typeof module&&module.exports?module.exports=function(t,n){return void 0===n&&(n="undefined"!=typeof window?require("jquery"):require("jquery")(t)),e(n),n}:e(jQuery)}(function(e){"use strict";e.fn.attrStartWith=function(e){return[].slice.call(this.get(0).attributes).filter(function(t){return t&&t.name&&0===t.name.indexOf(e)})},Array.prototype.mergeUnique=function(e){var t=this.concat(e).sort(function(e,t){return e>t?1:e<t?-1:0});return t.filter(function(e,n){return t.indexOf(e)===n})},String.prototype.toLowerFirstLetter=function(){return this.charAt(0).toLowerCase()+this.slice(1)};var t=(e('meta[name="async-http:use-actual-http-method"]').attr("content"),window.asyncHttp=function(){});t.RENDER_METHOD={prepend:0,replace:1,append:2},t.hasAsyncRequest=function(){return null!==n.currentRequest},t.cancelCurrentRequest=function(){this.hasAsyncRequest()!==!1&&n.currentRequest.cancel()},t.togglePollState=function(t){t=t instanceof jQuery?t:e(t);var n=t.data("async-poll-paused")||!1;n=!n,t.data("async-poll-paused",n),t.trigger("async:poll-pause",[n])},t.getAbsoluteUrl=function(){var e;return function(t){return e||(e=document.createElement("a")),e.href=t,e.href}}(),t.defaults={processIndicator:void 0,renderMethod:t.RENDER_METHOD.replace,actionDone:void 0,actionTarget:void 0,poll:void 0,pollRepeats:void 0,jsonHandler:e.noop,confirmHandler:function(t){return e.Deferred().resolve(confirm(t)).promise()}};var n={queue:[],queueRunning:!1,runQueue:function(){try{if(n.queueRunning)return;if(n.queueRunning=!0,n.currentRequest=n.queue.shift(),!n.currentRequest)return n.queueRunning=!1,void(n.currentRequest=null);n.currentRequest.request().done(function(){n.queueRunning=!1,n.currentRequest=null,n.runQueue()})}catch(e){console.error("AsyncHttp. runQueue error",e)}},currentRequest:null,getProcessIndicators:function(n,r){var a=void 0!==t.defaults.processIndicator?e(t.defaults.processIndicator):null;return r=r||".async-indicator:first",null!==a?a.add(e(r,n)):a=e(r,n),0===a.length&&(a=e(".async-indicator:first")),a.show()},processAutoLoads:function(t){var n=[];e("[data-async-autoload], [async-autoload]",t).each(function(e,t){n.push(new a(t))}),e.when.apply(e,n)},parseAction:function(t,n){for(var r=n.split(";"),a=0,o=r.length;a<o;a++){n=r[a];var s=n,i=[],c=null;if(n.indexOf(":")>=0){s=n.substr(0,n.indexOf(":")),i=e.trim(n.substr(n.indexOf(":")+1,n.length));try{window.eval.call(window,"args = ["+i+"]")}catch(e){c=[i]}}try{(t[s]||window[s]).apply(t,c)}catch(e){console.error("AsyncHttp. Invalid action exceuction from method: %s, with params %o",s,params)}}},defaultXhr:e.ajaxSettings.xhr,styleSheet:function(){var e=document.createElement("style");return e.appendChild(document.createTextNode("")),document.head.appendChild(e),e.sheet.insertRule(".async-indicator{display:none;}",0),e.sheet}()},r=function(r,a){var o=function(){var a=r.attrStartWith("async-");a=a.mergeUnique(r.attrStartWith("data-async-"));for(var o={},s=0,i=a.length;s<i;s++){var c=a[s],u=c.name.replace(/-([a-z])/g,function(e){return e[1].toUpperCase()}),l=c.value;switch(/^async/.test(u)&&(u=u.replace(/async/,"").toLowerFirstLetter()),u){case"renderMethod":l=t.RENDER_METHOD[l];break;case"processIndicator":l=n.getProcessIndicators(r,l);break;case"target":l=e(l),0===l.length&&(l=r);break;case"poll":l=isNaN(l)===!1?1e3*parseInt(l):l.lastIndexOf("ms")==l.length-2?parseFloat(l.substr(0,l.length-2)):l.lastIndexOf("s")==l.length-1?1e3*parseFloat(l.substr(0,l.length-1)):1e3;break;case"pollRepeats":l=parseInt(l)}o[u]=l}return o}();void 0===o.processIndicator&&(o.processIndicator=n.getProcessIndicators(r)),o.isAutoLoad=void 0!==o.autoload,void 0===o.target&&(o.target=r),o=e.extend({},t.defaults,o,a);var s=e.extend({},e.ajaxSettings,{context:r,url:r.attr("href")||r.attr("action")||o.autoload,xhr:function(){var e=n.defaultXhr();return e instanceof window.XMLHttpRequest&&e.addEventListener("progress",this.progress,!1),e.upload&&e.upload.addEventListener("progress",this.progress,!1),e},progress:function(e){if(e.lengthComputable){var t=e.loaded/e.total*100;r.trigger("async:onprogress",[t.toPrecision(3)])}},xhrFields:{onprogress:function(e){this.settings;if(e.lengthComputable){var t=e.loaded/e.total*100;r.trigger("async:onprogress",[t])}}},beforeSend:function(t,n){e(this).trigger("async:beforeSend",[t,n]),this.settings=n},error:function(t,n,r){e(this).trigger("async:error",[t,n,r])},success:function(t,n,r){e(this).trigger("async:success",[t,r,n])},complete:function(t,r){var a=e(this);a.trigger("async:complete",[t,r]),"undefined"!=typeof ga?ga("send","pageview",{location:this.settings.url,hitCallback:function(){a.trigger("async:ga-done",[a]),console.groupEnd(),"gaEventAction"in o&&ga("send","event",{eventCategory:o.gaEventCategory||"UnCategorized",eventAction:o.gaEventAction||"click",eventLabel:o.gaEventLabel||a.is("a")?e.trim(a.text()):"Not seted"})}}):console.groupEnd(),n.runQueue()}});return e.extend({},s,o)},a=t.request=function(o,s){void 0===o||null===o?o=e():e.isPlainObject(o)&&e.isEmptyObject(o)&&void 0!==o.url&&(s=o,o=e()),o=o instanceof jQuery?o:e(o);var i=this,c=this.config=new r(o,s||{});if(console.group("New async request for %o",c),c.isAutoLoad===!1&&(o.is("a")||o.is("form"))===!1)throw new Error("The async request can't be created, the context is not valid.");o.trigger("async:start",[c]);var u=function(e){var n=c.target;switch(c.renderMethod){case t.RENDER_METHOD.append:n.append(e);break;case t.RENDER_METHOD.replace:n.html(e);break;case t.RENDER_METHOD.prepend:n.prepend(e);break;default:new Error("Undefined render method")}},l=e.Deferred(),d={done:function(t,r){u(t),void 0!==c.actionDone&&n.parseAction(e(c.actionTarget||c.target),c.actionDone),n.processAutoLoads(c.target),o.trigger("async:done",[i]),l.resolve(t,r,i)},fail:function(e,t,n){u(e.responseText),o.trigger("async:fail",[i]),l.fail(e,t,n,i)},always:function(){c.processIndicator.parent().length>0&&c.processIndicator.fadeOut(),o.trigger("async:always",[i]),l.always(i)}};if(void 0!==c.confirm){var f=/^(\{|\[)/.test(c.confirm)?JSON.parse(c.confirm):c.confirm,p=e.isArray(f)?f:[f];e.when(t.defaults.confirmHandler.apply(this,p)).done(function(t){c.target.trigger("async:confirm",[t]),i.request=t?function(){return e.ajax(c).done(d.done).fail(d.fail).always(d.always)}:function(){return e.Deferred().done(d.done).fail(d.fail).always(d.always).resolve(void 0)},n.queue.push(i),n.runQueue()})}else this.request=function(){return e.ajax(c).done(d.done).fail(d.fail).always(d.always)},n.queue.push(i),n.runQueue();return a.prototype.cancel=function(){request.abort(),this.config.target.trigger("async:aborted")},void 0!==c.poll&&o.data("async-poll-interval",setTimeout(function e(){var t=o.data("async-interval"),n=o.data("async-poll-executions")||0,r=o.data("async-poll-paused")===!0;try{r?o.data("async-poll-interval",setTimeout(e,c.poll)):void 0!==c.pollRepeats&&n==c.pollRepeats?(clearTimeout(t),o.data("async-poll",void 0)):(o.data("async-poll-executions",n+1),new a(o))}catch(e){throw e}finally{o.trigger("async:poll",[n,r])}},c.poll)),l.promise()};t.isOnLine=navigator.onLine||void 0,e([window,document]).on("online offline",function(e){e.preventDefault(),e.stopPropagation(),"online"===e.type?t.isOnLine=!0:t.isOnLine=!1}),e(document).on("click","a[disabled]",function(e){e.preventDefault(),e.stopPropagation()}),e(document).on("click","a[async]",function(t){t.preventDefault(),t.stopPropagation();var n=e(this);new a(n)}),e(document).on("submit","form[async]",function(t){t.preventDefault(),t.stopPropagation();var n=e(this);e.fn&&e.fn.button&&e(":submit, :reset",n).button("loading"),new a(n)}),e(document).ready(function(){n.processAutoLoads(document.body)}),e(window).on("beforeunload",function(e){if(asyc.hasAsyncRequest())return"Existe uma solicitação em andamento, deseja realmente sair?"}),e.fn.__load=e.fn.load,e.fn.load=function(t,n,r){var o=e(this);o.attr("async-autoload",t),new a(o).done(function(t){(r||e.noop)(t),o.trigger("async:load-done",[t])})}});